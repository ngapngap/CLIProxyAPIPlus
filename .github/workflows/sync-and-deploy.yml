name: Sync and Deploy to Heroku

on:
  schedule:
    - cron: '0 2 * * *'  # Ch·∫°y h√†ng ng√†y l√∫c 2:00 UTC (9:00 VN)
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without changes'
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.sync.outputs.has_updates }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync from upstream
        id: sync
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/router-for-me/CLIProxyAPIPlus.git || true
          git fetch upstream main --tags

          # Check if there are updates
          LOCAL=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse upstream/main)

          if [ "$LOCAL" != "$UPSTREAM" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            git merge upstream/main --allow-unrelated-histories -m "Sync from upstream" || true
            git push origin main --tags
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates from upstream"
          fi

  export-usage:
    runs-on: ubuntu-latest
    needs: sync
    if: needs.sync.outputs.has_updates == 'true' || github.event_name != 'schedule' || github.event.inputs.force_deploy == 'true'
    outputs:
      backup_available: ${{ steps.export.outputs.success }}
    steps:
      - name: Export Usage Statistics
        id: export
        continue-on-error: true
        env:
          APP_NAME_RAW: ${{ vars.HEROKU_APP_NAME || secrets.HEROKU_APP_NAME }}
          MGMT_KEY: ${{ secrets.MANAGEMENT_API_KEY }}
        run: |
          APP_NAME=$(echo "$APP_NAME_RAW" | tr '[:upper:]' '[:lower:]')
          if [ -n "$MGMT_KEY" ] && [ -n "$APP_NAME" ]; then
            curl -s -f "https://${APP_NAME}.herokuapp.com/v0/management/usage/export" \
              -H "Authorization: Bearer ${MGMT_KEY}" \
              -o usage_backup.json || echo '{}' > usage_backup.json
            echo "success=true" >> $GITHUB_OUTPUT
            echo "Usage stats exported"
          else
            echo '{}' > usage_backup.json
            echo "success=false" >> $GITHUB_OUTPUT
            echo "Skipping usage export - no management key configured"
          fi

      - name: Upload Usage Backup
        uses: actions/upload-artifact@v4
        with:
          name: usage-backup
          path: usage_backup.json
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: [sync, export-usage]
    if: needs.sync.outputs.has_updates == 'true' || github.event_name != 'schedule' || github.event.inputs.force_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags

      - name: Build Docker Image
        id: build
        run: |
          VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          echo "Building with:"
          echo "  Version: ${VERSION}"
          echo "  Commit: ${COMMIT}"
          echo "  Build Date: ${BUILD_DATE}"

          docker build \
            --build-arg VERSION="${VERSION}" \
            --build-arg COMMIT="${COMMIT}" \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            -t cliproxyapiplus:latest .

          echo "image_tag=cliproxyapiplus:latest" >> $GITHUB_OUTPUT

      - name: Login to Heroku Registry
        run: |
          echo "${{ secrets.HEROKU_API_KEY }}" | \
            docker login --username=_ --password-stdin registry.heroku.com

      - name: Validate Heroku Config
        id: heroku_config
        env:
          APP_NAME_RAW: ${{ vars.HEROKU_APP_NAME || secrets.HEROKU_APP_NAME }}
        run: |
          if [ -z "$APP_NAME_RAW" ]; then
            echo "::error::HEROKU_APP_NAME is not set. Please add it to Repository Secrets or Variables."
            exit 1
          fi
          # Heroku app names and Docker registry require lowercase
          APP_NAME=$(echo "$APP_NAME_RAW" | tr '[:upper:]' '[:lower:]')
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ APP_NAME: ${APP_NAME}"

      - name: Tag and Push Image
        run: |
          APP_NAME="${{ steps.heroku_config.outputs.app_name }}"
          echo "Tagging image for ${APP_NAME}..."
          docker tag cliproxyapiplus:latest "registry.heroku.com/${APP_NAME}/web"
          echo "Pushing image to registry.heroku.com/${APP_NAME}/web..."
          docker push "registry.heroku.com/${APP_NAME}/web"
          echo "‚úÖ Pushed image to registry.heroku.com/${APP_NAME}/web"

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install-ubuntu.sh | sh

      - name: Release
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          APP_NAME="${{ steps.heroku_config.outputs.app_name }}"
          heroku container:release web -a "${APP_NAME}"
          echo "‚úÖ Released to ${APP_NAME}"

      - name: Health Check
        continue-on-error: true
        run: |
          APP_NAME="${{ steps.heroku_config.outputs.app_name }}"
          echo "Waiting for app to start..."
          sleep 60

          for i in 1 2 3; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${APP_NAME}.herokuapp.com/health" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ App ${APP_NAME} is healthy"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_CODE - retrying..."
            sleep 30
          done
          echo "‚ö†Ô∏è Health check failed"

  import-usage:
    runs-on: ubuntu-latest
    needs: [deploy, export-usage]
    if: always() && needs.export-usage.outputs.backup_available == 'true'
    steps:
      - name: Download Usage Backup
        uses: actions/download-artifact@v4
        with:
          name: usage-backup

      - name: Import Usage Statistics
        continue-on-error: true
        env:
          APP_NAME_RAW: ${{ vars.HEROKU_APP_NAME || secrets.HEROKU_APP_NAME }}
          MGMT_KEY: ${{ secrets.MANAGEMENT_API_KEY }}
        run: |
          APP_NAME=$(echo "$APP_NAME_RAW" | tr '[:upper:]' '[:lower:]')
          if [ -z "$MGMT_KEY" ] || [ -z "$APP_NAME" ]; then
            echo "No management API key configured - skipping import"
            exit 0
          fi

          APP_URL="https://${APP_NAME}.herokuapp.com"

          # Retry import up to 5 times
          for i in 1 2 3 4 5; do
            echo "Attempt $i to import usage stats..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${APP_URL}/v0/management/usage/import" \
              -H "Authorization: Bearer ${MGMT_KEY}" \
              -H "Content-Type: application/json" \
              -d @usage_backup.json)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Usage stats imported successfully"
              exit 0
            fi

            echo "Failed with code $HTTP_CODE, retrying in 30s..."
            sleep 30
          done

          echo "‚ö†Ô∏è Failed to import usage stats after 5 attempts"

  summary:
    runs-on: ubuntu-latest
    needs: [deploy, import-usage]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "### üöÄ Deployment Summary"
          echo ""
          echo "**Trigger:** ${{ github.event_name }}"
          echo "**Force Deploy:** ${{ github.event.inputs.force_deploy || 'false' }}"
          echo ""
          echo "**Deploy Status:** ${{ needs.deploy.result }}"
          echo "**Import Usage Status:** ${{ needs.import-usage.result }}"
          echo ""
          echo "‚úÖ Deployment workflow completed"
